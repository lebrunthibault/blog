<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"
        integrity="sha256-EXPXz4W6pQgfYY3yTpnDa3OH8/EPn16ciVsPQ/ypsjk=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.8.3/dist/instantsearch.production.min.js"
        integrity="sha256-LAGhRRdtVoD6RLo2qDQsU2mp+XVSciKRC8XPOBWmofM=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css"
      integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">
<script defer>
    if (document.querySelector("#search-bar")) {
        loadAlgolia();
    }

    function loadAlgolia() {
        const searchClient = algoliasearch('F3KLJN3L59', '85cd499b6fcbe9010c77a66bbee801b3');
        console.log({{ getenv "ALGOLIA_INDEX_NAME" }})
        const search = instantsearch({
            indexName: '{{ getenv "ALGOLIA_INDEX_NAME" }}',
            searchClient,
            initialUiState: {
                indexName: {
                    query: '',
                },
            },
            searchFunction: helper => {
                if (helper.state.query.length) {
                    helper.search();
                } else {
                    $('#hits').hide()
                }
            }
        });

        function itemToHtml(item) {
            console.log(item)
            title = item._highlightResult.title.value || item.title
            summary = item._highlightResult.summary.value || item.summary
            return `<a href="${item.url}">
                    <div class="title">${title}</div>
                    ${summary}</a>`
        }

        search.addWidgets([
            instantsearch.widgets.searchBox({
                container: '#search-bar',
                placeholder: 'Search for posts',
                autofocus: false,
                showReset: false,
            }),

            instantsearch.widgets.hits({
                container: '#hits',
                templates: {
                    item: itemToHtml
                },
            })

        ]);

        search.start();

        $(document).on('click', function (event) {
            if (!$(event.target).closest('.ais-InstantSearch').length) {
                $('#hits').hide()
            }
        });

        $('.ais-InstantSearch').on('click keypress', function (event) {
            $('#hits').show()
        });

        $('.ais-SearchBox-input').on('focus', function (event) {
            $('#hits').show()
        });
    }
</script>
