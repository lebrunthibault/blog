<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Ableton notes - Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Thibault Lebrun" /><meta name="description" content="download archives  Bugs  Minitaur editor disconnected :  only minitaur out / track is necessary simply reload the minitaur editor If not working unplug / plug the usb cable and reload editor    MIDI Jitter http://www." /><meta name="keywords" content="" />






<meta name="generator" content="Hugo 0.89.2 with theme even" />


<link rel="canonical" href="https://lebrunthibault.github.io/post/ableton/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.1289be4fc6296c288db4a9b805f568bb0a4e955787fe892dff9e3aba3afd6403.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Ableton notes" />
<meta property="og:description" content="download archives  Bugs  Minitaur editor disconnected :  only minitaur out / track is necessary simply reload the minitaur editor If not working unplug / plug the usb cable and reload editor    MIDI Jitter http://www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lebrunthibault.github.io/post/ableton/" /><meta property="article:section" content="post" />

<meta property="article:modified_time" content="2021-11-14T16:04:37+01:00" />

<meta itemprop="name" content="Ableton notes">
<meta itemprop="description" content="download archives  Bugs  Minitaur editor disconnected :  only minitaur out / track is necessary simply reload the minitaur editor If not working unplug / plug the usb cable and reload editor    MIDI Jitter http://www.">
<meta itemprop="dateModified" content="2021-11-14T16:04:37+01:00" />
<meta itemprop="wordCount" content="1006">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ableton notes"/>
<meta name="twitter:description" content="download archives  Bugs  Minitaur editor disconnected :  only minitaur out / track is necessary simply reload the minitaur editor If not working unplug / plug the usb cable and reload editor    MIDI Jitter http://www."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Home</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <div class="ais-InstantSearch">
    <div id="search-bar"></div>
    <div id="hits"></div>
    <div id="pagination"></div>
</div>
<article class="post">
    
    <header class="post-header">
        <h1 class="post-title">Ableton notes</h1>

        <div class="post-meta">
            
            <span class="more-meta"> 5 mins read </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#bugs">Bugs</a></li>
    <li><a href="#midi-jitter">MIDI Jitter</a>
      <ul>
        <li>
          <ul>
            <li><a href="#midi-connections-comparison">Midi connections comparison</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#reducing-latency-when-monitoring">Reducing latency when monitoring</a></li>
    <li><a href="#recording-external-synth-with-no-latency">Recording external synth with no latency</a>
      <ul>
        <li>
          <ul>
            <li></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#midi-jitter-1">Midi jitter</a>
      <ul>
        <li>
          <ul>
            <li></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#vst2--vst3">VST2 / VST3</a></li>
    <li><a href="#clean-sidechain-compression">Clean sidechain compression</a>
      <ul>
        <li>
          <ul>
            <li></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#changing-tempo-from-a-midi-clip-in-session-view">Changing tempo from a midi clip in session view</a></li>
    <li><a href="#quantization">Quantization</a></li>
    <li><a href="#presets">Presets</a></li>
    <li><a href="#speed-up-sets-load-time">Speed up sets load time</a>
      <ul>
        <li>
          <ul>
            <li><a href="#push2">Push2</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#midi-ports">Midi ports</a></li>
    <li><a href="#reinstall">Reinstall</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
        <ul>
<li><a href="https://www.ableton.com/en/download/archive/">download archives</a></li>
</ul>
<h1 id="bugs">Bugs</h1>
<ul>
<li>Minitaur editor disconnected :
<ul>
<li>only minitaur out / track is necessary</li>
<li><strong>simply reload the minitaur editor</strong></li>
<li>If not working unplug / plug the usb cable and reload editor</li>
</ul>
</li>
</ul>
<h1 id="midi-jitter">MIDI Jitter</h1>
<p><a href="http://www.audiodesignguide.com/DAC_final/how.htm">http://www.audiodesignguide.com/DAC_final/how.htm</a></p>
<p><a href="https://www.ableton.com/en/manual/midi-fact-sheet/">https://www.ableton.com/en/manual/midi-fact-sheet/</a></p>
<p><a href="http://www.users.on.net/~mcdds001/mmmmqac/midi_jitter.html">Midi latency analyzer</a></p>
<p><a href="https://www.reddit.com/r/linuxaudio/comments/9kg418/how_to_eliminate_midi_jitter/">how to eliminate midi jitter reddit</a></p>
<p><a href="https://www.thomann.de/fr/e_rm_multiclock_usb.htm">https://www.thomann.de/fr/e_rm_multiclock_usb.htm</a> : 500 balles mais apparemment top: clock sync via un signal audio. <a href="https://reverb.com/fr/item/41066860-erm-multiclock-usb">moins cher ici</a></p>
<h3 id="midi-connections-comparison">Midi connections comparison</h3>
<ul>
<li>DIN 5-pin classic MIDI:
<ul>
<li>A latency/jitter of minimum 1ms (time to process a 3 byte midi message)</li>
<li>Jitter acceptable</li>
</ul>
</li>
<li>Usb:
<ul>
<li>More throughput</li>
<li>Usually higher jitter</li>
</ul>
</li>
<li>Ethernet / IP
<ul>
<li>better ?</li>
</ul>
</li>
</ul>
<p><strong>Possibilities</strong>:</p>
<ul>
<li><a href="https://www.iconnectivity.com/mioxm">https://www.iconnectivity.com/mioxm</a></li>
</ul>
<h1 id="reducing-latency-when-monitoring">Reducing latency when monitoring</h1>
<blockquote>
<p>See <a href="https://focusrite.com/en/news/system-science-part-2-drivers-latency">focusrite article</a></p>
</blockquote>
<ul>
<li>Best solution : use an external mixer that feeds in the audio soundcard and monitor directly to the mixer (analog signal path). <em>Complicated for me</em></li>
<li>Usual solution: use direct monitoring in the sound card BUT we get the A/D + D/A latency</li>
<li>Anyway: record in ableton with monitoring off</li>
</ul>
<h1 id="recording-external-synth-with-no-latency">Recording external synth with no latency</h1>
<blockquote>
<p>See <a href="https://www.youtube.com/watch?v=PT5mD2Zd7F8">this video about audio latency</a>, <a href="https://www.youtube.com/watch?v=WkQkzBB6Szc">this one about midi to audio latency</a> and <a href="https://help.ableton.com/hc/fr-fr/articles/360006569179-Le-monitoring-dans-Live">Ableton doc</a></p>
</blockquote>
<p><strong>Monitoring modes</strong></p>
<ul>
<li>In : signal toujours entendu mais avec latence</li>
<li>Auto: signal entendu seulement quand track arm avec latence</li>
<li>Off : signal non entendu, zero latence</li>
</ul>
<blockquote>
<p>With In or Auto: live aligns the audio with what&rsquo;s <em>heard</em> (input + output latency)</p>
<p>With off : it&rsquo;s aligned with what you play (delay compensation of soundcard / driver latency and of plugin latency</p>
</blockquote>
<p><strong>Options &gt; Delay compensation</strong></p>
<ul>
<li>Compensates for plugins / effects latency. <strong>leave it on</strong>.</li>
<li>NB: effect latency is show in the status bar when hovering over effect.</li>
<li>All the tracks are started as to sync with the most delayed one</li>
<li>NB : disabling a plugin does not remove its latency while delay compensation if on (it does when it&rsquo;s off)</li>
</ul>
<p><strong>Options &gt; Reduced latency when monitoring</strong></p>
<ul>
<li>For audio tracks, deactivates delay compensation for this track.</li>
<li>track will start <strong>before</strong> other tracks if it&rsquo;s total effect latency if &lt; the most delayed track</li>
<li>NB: it is not the same as direct monitoring, the tracks is still heard after all effect processing is done (thus with its own effect latency, as well as master) but is not affected to other tracks own latencies.</li>
</ul>
<p><strong>External instrument</strong></p>
<ul>
<li>Adds a latency equals to the system latency (in + out as seen in Preferences &gt; audio &gt; latency)</li>
<li>record audio by :
<ul>
<li>freezing the track !</li>
<li>adding a new audio track</li>
</ul>
</li>
</ul>
<p><strong>Recording direct audio (without feeding midi)</strong></p>
<blockquote>
<p>I&rsquo;m actually not doing this</p>
</blockquote>
<ul>
<li>Use monitoring <strong>off</strong> and use soundcard direct monitoring <strong>or</strong> use another track for monitoring (with monitor auto or in).</li>
</ul>
<h4 id="recording-audio-by-sending-midi-with-no-latency-and-low-jitter">Recording audio by sending midi with no latency and low jitter</h4>
<ul>
<li>
<p>Driver error compensation : <strong>0ms</strong></p>
</li>
<li>
<p>Buffer size: <strong>128 samples</strong></p>
</li>
<li>
<p>Sample rate : <strong>88200Hz</strong></p>
</li>
</ul>
<p><strong>Minitaur</strong></p>
<ul>
<li>Midi track with <strong>external instrument</strong> and <strong>Minitaur Editor(x64)</strong></li>
<li>external instrument hardware latency : <strong>3ms</strong></li>
<li>Audio track taking audio from midi track <strong>pre fx</strong></li>
</ul>
<p><strong>Prophet</strong></p>
<ul>
<li>Midi track with <strong>external audio effect</strong></li>
<li>external instrument hardware latency : <strong>0ms</strong></li>
<li>Audio track taking audio from midi track <strong>post fx</strong> (because we use external audio effect)</li>
</ul>
<h1 id="midi-jitter-1">Midi jitter</h1>
<ul>
<li>Around 10ms at SR 44100</li>
<li>Around 5ms at SR 88200</li>
<li>High SR + low buffer size = 2 ms !</li>
</ul>
<p><strong>Solution</strong></p>
<ul>
<li>High SR</li>
<li>Low buffer size</li>
</ul>
<p><strong>More</strong></p>
<ul>
<li>Check out focusrite windows optimizing <a href="https://support.focusrite.com/hc/en-gb/articles/207355205-Optimising-your-PC-for-Audio-on-Windows-10">tutorial</a></li>
</ul>
<h4 id="should-i-use-a-midi-interface--possibilities-are">Should I use a midi interface ? Possibilities are</h4>
<ul>
<li><a href="https://www.thomann.de/fr/e_rm_midiclock.htm">E-RM Midi clock</a> : horloge maitre externe mais pas utile pour envoyer du midi aux synthés ?</li>
<li><a href="https://www.thomann.de/fr/roland_um_one_mkii.htm">Roland UM-One MkII</a> : cable usb to 2 * midi : peut permetttre de réduire le jitter de l&rsquo;ordi au synth par rapport a un cable usb normal</li>
<li>Use a high end audio soundcard using pll (focusrite <a href="https://pro.focusrite.com/what-is-jetpll">jetpll</a>)</li>
<li><a href="https://www.thomann.de/fr/expert_sleepers_usamo.htm">Expert sleeper USAMO</a>:</li>
</ul>
<h1 id="vst2--vst3">VST2 / VST3</h1>
<ul>
<li>vst3 détectent si du signal passent et se désactivent.</li>
</ul>
<h1 id="clean-sidechain-compression">Clean sidechain compression</h1>
<blockquote>
<p>See <a href="https://www.youtube.com/watch?v=Gc4pehOp-Y4">this video</a></p>
</blockquote>
<h4 id="using-compressor">Using compressor</h4>
<blockquote>
<p>Good for dynamic source, simpler to setup</p>
</blockquote>
<ul>
<li>sidechain input pre-fx</li>
<li>Ratio infinite</li>
<li>attack the lowest possible without artefacts</li>
<li>detection mode: peak (especially for drums)</li>
</ul>
<h4 id="using-lfotool">Using LFOTool</h4>
<blockquote>
<p>Good for source with fixed velocity</p>
</blockquote>
<ul>
<li>Do not send directly midi to the lfo tool
<ul>
<li>create a midi track with an external instrument to have <strong>latency compensation</strong> and copy paste midi notes</li>
<li>one midi track and one lfo tool per sidechain source</li>
</ul>
</li>
<li>Lfo tool midi conf: note retrigger in <strong>env</strong> mode</li>
<li>handle clipping on attack : use <strong>smooth</strong> param but sometimes it&rsquo;s good to add punch</li>
<li>Make it less aggresive by using the <strong>split</strong> button (down right).</li>
</ul>
<h1 id="changing-tempo-from-a-midi-clip-in-session-view">Changing tempo from a midi clip in session view</h1>
<blockquote>
<p>See <a href="https://www.google.com/search?q=ableton+use+clip+automation+in+session+view+tempo&amp;sxsrf=ALeKk03sqbx6h2aMlrhmod7qNzUIMzUX4A:1630011657440&amp;ei=CQEoYeG1GoedlwSt5rzoBA&amp;start=0&amp;sa=N&amp;ved=2ahUKEwih3sjOys_yAhWHzoUKHS0zD004ChDx0wN6BAgBEEA&amp;biw=1536&amp;bih=722#kpvalbx=_AgEoYevHEsvwaMj1reAN41">this video</a></p>
</blockquote>
<h1 id="quantization">Quantization</h1>
<ul>
<li><strong>Global launch quantization</strong> (up left) == <code>Song.clip_trigger_quantization</code>. The launch clip quantization (set to <strong>1 bar</strong>)</li>
<li>Edit-&gt;Record Quantization == <code>Song.midi_recording_quantization</code>. The automatic quantization (used for midi clips).</li>
<li>We can independently quantize a clip / specific notes with the <strong>quantize command</strong> (<code>ctrl+u</code>)</li>
</ul>
<h1 id="presets">Presets</h1>
<p><strong>Preset files</strong></p>
<ul>
<li>Fxp file : FX preset</li>
<li><a href="https://www.lifewire.com/fxb-file-2621469">Fxb file</a> : FX bank</li>
<li>Files are plugin specific. A bank is made of presets, save as fxp and you save the current patch, save as fxb and you save all the presets loaded in your synth as one bank (<em>Example : Sylenth</em>)</li>
</ul>
<p><strong>Save / Load presets</strong></p>
<ul>
<li><img src="https://lh5.googleusercontent.com/7LGlz_RzXxxTO3dT8G6QiIdrFH3BSIftiZCJZiT92A8bTWCdg0a6vlsuUuBatM6JtcLvdP5iM2xVt3AkNgfw9Yad2if80xk4uIk_uW3JHBvofsZhpht8c-OcTpxwwGU9YaQq_Ww-=s0" alt="img"> : Use live to save a <a href="https://www.lifewire.com/fxb-file-2621469">fxb file</a> on your hard drive.  You can use the folder button to the left to load the preset bank.</li>
<li><img src="https://lh5.googleusercontent.com/Pm6Ls_ZbqPjPu-vXHhRHIy_jyoIv2g0JRxoBgsb-GcearzMw8cdoEkpaZXsqdSXnOex-OR1Jpbd_D8wTWP1ldNeWCOY4c6pNOQ4aMdxIXPURXE5IVhAmxLVyLdgncjJGCWCTld_c=s0" alt="img">(<em>LFOTool example</em>) : use the vst plugin to save the preset file to disk</li>
</ul>
<h1 id="speed-up-sets-load-time">Speed up sets load time</h1>
<p>See <a href="https://docs.google.com/spreadsheets/d/1m4vL2dqWhx6PyerJknqP2iwtY84NHFEjbPKmC1VfdUE/edit#gid=0">https://docs.google.com/spreadsheets/d/1m4vL2dqWhx6PyerJknqP2iwtY84NHFEjbPKmC1VfdUE/edit#gid=0</a></p>
<h3 id="push2">Push2</h3>
<p>​	Push2 adds 1.5 to 2s (even only the script)</p>
<p>​	<code>caps.TYPE_KEY: u'push2',  # this takes some time</code> in <code>__init__.py</code></p>
<h1 id="midi-ports">Midi ports</h1>
<p>See <a href="https://help.ableton.com/hc/fr-fr/articles/209774205-Les-ports-MIDI-de-Live-comment-%C3%A7a-marche">https://help.ableton.com/hc/fr-fr/articles/209774205-Les-ports-MIDI-de-Live-comment-%C3%A7a-marche</a></p>
<ul>
<li>Track : Note on, Note off, CC, program change</li>
<li>Sync : clock info</li>
<li>Remote : Assignation midi (input) and assigned midi parameters change</li>
</ul>
<h1 id="reinstall">Reinstall</h1>
<ul>
<li>Install removes all the *C:\ProgramData\Ableton\Live 10 Suite* directory. Including remote scripts</li>
<li>Backup remote scripts or check nothing to commit</li>
<li>Backup env file</li>
<li>Install Ableton</li>
<li>Change the env var ableton_version</li>
<li>Copy back :
<ul>
<li>git clone protocol0 and <strong>checkout dev</strong></li>
<li>Protocol0 script with name <strong>a_protocol_0</strong></li>
<li>Protocol0 midi script</li>
<li>Clyphx Pro</li>
<li>Push 2 procotol0 with name <strong>a_push2</strong></li>
</ul>
</li>
</ul>
<p>Test code for remote script</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">_Framework.ControlSurface</span> <span class="kn">import</span> <span class="n">ControlSurface</span>

<span class="k">def</span> <span class="nf">create_instance</span><span class="p">(</span><span class="n">c_instance</span><span class="p">):</span>  <span class="c1"># noqa</span>
    <span class="k">return</span> <span class="n">ControlSurface</span><span class="p">(</span><span class="n">c_instance</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
        </footer>
</article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
    <a href="https://github.com/lebrunthibault" class="iconfont icon-github" title="github"></a>
    <a href="https://www.linkedin.com/in/thibault-lebrun/" class="iconfont icon-linkedin" title="linkedin"></a>
    <a href="mailto:thibaultlebrun@live.fr" class="iconfont icon-email" title="email"></a>
    <a href="https://lebrunthibault.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>


    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"
        integrity="sha256-EXPXz4W6pQgfYY3yTpnDa3OH8/EPn16ciVsPQ/ypsjk=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.8.3/dist/instantsearch.production.min.js"
        integrity="sha256-LAGhRRdtVoD6RLo2qDQsU2mp+XVSciKRC8XPOBWmofM=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css"
      integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">
<script>
    function isDevMode() {
        const isDevMode = '' === "dev" ||
        new URLSearchParams(window.location.search).get("dev") !== null ||
        new URLSearchParams(window.location.search).get("d") !== null ||
        Boolean(localStorage.getItem("dev-mode"));

        
        return isDevMode && new URLSearchParams(window.location.search).get("prod") === null
    }
    const devMode = isDevMode()
    localStorage.setItem("dev-mode",devMode ? "true": "")

    if (devMode) {
        
        Array.from(document.querySelectorAll(".post")).map(el => el.style.display = "block")
        if (window.location.pathname === "/") {
            document.querySelector(".posts").classList.add("dev")
        }
    }

    if (document.querySelector("#search-bar")) {
        if (window.location.pathname === "/" ||devMode) {
            loadAlgolia();
        }
    }

    function loadAlgolia() {
        const searchClient = algoliasearch('F3KLJN3L59', '85cd499b6fcbe9010c77a66bbee801b3')
        const search = instantsearch({
            indexName: 'blog',
            searchClient,
            searchFunction: helper => {
                const query_length = helper.state.query.length
                if (query_length === 0) {
                    $('#hits').hide()
                } else if (query_length >= 3) {
                    if (!devMode) {
                        const draft = "draft"
                        if (!helper.state.isConjunctiveFacet(draft)) {
                            helper.state.facets.push(draft)
                        }
                        helper.addFacetRefinement(draft, false)
                    }

                    helper.search();
                }
            }
        });

        function itemToHtml(item) {
            title = item._highlightResult.title.value || item.title
            description = item.description && item._highlightResult.description.value
            description = description ? description : ""

            keywords_matched = []
            if (item.keywords && item._highlightResult.keywords) {
                keywords_matched = item._highlightResult.keywords.filter(h => h.matchLevel === "full").map(h => h.value).slice(0, 2)
            }
            keywords_html = keywords_matched.length ? keywords_matched.map(k => `<span class="badge">${k}</span>`).join(" ") : ""

            headers_matched = []
            if (item.headers && item._highlightResult.headers) {
                headers_matched = item._highlightResult.headers.filter(h => h.matchLevel === "full").map(h => h.value).slice(0, 2)
            }
            headers_html = headers_matched.length ? headers_matched.map(h => `<li>${h}</li>`).join("") : ""
            return `<a href="${item.url}">
                        <div class="title">${title}</div>
                        <div class="description">${description}</div>
                        ${keywords_html}
                        <ul class="headers">${headers_html}</ul>
                    </a>`
        }

        search.addWidgets([
            instantsearch.widgets.searchBox({
                container: '#search-bar',
                placeholder: 'Search for posts',
                autofocus: true,
                showReset: false,
            }),

            instantsearch.widgets.hits({
                container: '#hits',
                templates: {
                    item: itemToHtml
                },
            })

        ]);

        search.start();

        $(document).on('click', function (event) {
            if (!$(event.target).closest('.ais-InstantSearch').length) {
                $('#hits').hide()
            }
        });

        
        $('.ais-InstantSearch').on('click keypress', function (event) {
            $('#hits').show()
        });


        $('.ais-SearchBox-input').on('focus', function (event) {
            $('#hits').show()
        });


        
        $('.ais-InstantSearch').on(' keypress', function (event) {
            if (event.key === "Enter" && $('#hits a').length) {
                $('#hits a')[0].click()
            }
        });

    }
</script>


<link rel="stylesheet" href="/css/prism.css">
<script src="/js/prism.js"></script>



</body>
</html>
